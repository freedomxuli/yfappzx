<!DOCTYPE html>
<html class="ui-page-login">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>补充信息</title>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/feedback.css"/>
		<link href="../css/mui.picker.min.css" rel="stylesheet" />
		<link href="../css/mui.poppicker.css" rel="stylesheet" />
		<style>
			body{
				background-color: #FFFFFF;
			}
			.top-box{
				display: flex;
				flex-direction: row;
				align-items:center;
				background-color: #0078B9;
			}
			.top-box-item{
				flex: 1;
			}
			.top-box-item2{
				flex: 1.5;
			}
			.top-box-item-left{
				text-align: left;
			}
			.top-box-item-center{
				text-align: left;
			}
			.top-div-span{
				color: #FFFFFF;
				font-weight: bold;
				font-size: 1.2rem;
			}
			.top-div-img{
				height:1rem;
				vertical-align: middle;
			}
			#head-img1 {
				position: absolute;
				bottom: 10px;
				right: 40px;
				width: 40px;
				height: 40px;
			}
			#yyzz-img{
				position: absolute;
				bottom: 10px;
				right: 40px;
				width: 40px;
				height: 40px;
			}
			#sfz-img {
				position: absolute;
				bottom: 10px;
				right: 40px;
				width: 40px;
				height: 40px;
			}
			#sfz-img1 {
				position: absolute;
				bottom: 10px;
				right: 40px;
				width: 40px;
				height: 40px;
			}
			#sfz-img2 {
				position: absolute;
				bottom: 10px;
				right: 40px;
				width: 40px;
				height: 40px;
			}
			#mtz-img {
				position: absolute;
				bottom: 10px;
				right: 40px;
				width: 40px;
				height: 40px;
			}
			#zxfc-img {
				position: absolute;
				bottom: 10px;
				right: 40px;
				width: 40px;
				height: 40px;
			}
			.head {
				height: 40px;
			}
			#head {
				line-height: 40px;
				padding-left: 2rem;
			}
			#sfz {
				line-height: 40px;
				padding-left: 2rem;
			}
			#sfz1 {
				line-height: 40px;
				padding-left: 2rem;
			}
			#sfz2 {
				line-height: 40px;
				padding-left: 2rem;
			}
			#mtz {
				line-height: 40px;
				padding-left: 2rem;
			}
			#zxfc {
				line-height: 40px;
				padding-left: 2rem;
			}
			.head-img {
				width: 40px;
				height: 40px;
			}
		</style>
	</head>
	<body>
<!--		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">重置密码</h1>
		</header>-->
		<header class="mui-bar mui-bar-nav top-box">
			<div class="top-box-item mui-action-back">
				<img class="top-div-img" src="../img/buycontent/back.png" />
			</div>
			<div class="top-box-item2 top-box-item-center">
				<span class="top-div-span">补充信息</span>
			</div>
		</header>
		<div class="mui-content">
			<ul class="mui-table-view">
					<li class="mui-table-view-cell">
						<div class="mui-input-row">
							<label>门店地址:</label>
							<input id='MDDZ' type="text" class="mui-input-clear mui-input" placeholder="请输入门店地址">
						</div>
					</li>
					<li class="mui-table-view-cell">
						<div class="mui-input-row">
							<label>联系电话:</label>
							<input id='usertel' type="text" class="mui-input-clear mui-input" placeholder="请输入联系电话">
						</div>
					</li>
					<li class="mui-table-view-cell">
						<div class="mui-input-row">
							<label>线路起点:</label>
							<input id='XLQD' type="text" class="mui-input-clear mui-input" readonly="readonly" placeholder="请选择线路起点">
						</div>
					</li>
					<li class="mui-table-view-cell">
						<div class="mui-input-row">
							<label>线路终点:</label>
							<textarea id="XLZD" rows="5" placeholder="请输入线路终点"></textarea>
						</div>
					</li>
					<li class="mui-table-view-cell">
						<div class="mui-input-row">
							<label>专线简介:</label>
							<textarea id="textarea" rows="5" placeholder="请输入简介"></textarea>
						</div>
					</li>
					<li class="mui-table-view-cell" id="img-1">
						<a id="head" class="mui-navigate-right">营业执照
							<span class="mui-pull-right head">
								<input type="hidden" id="yyzz-img-src" value="">
								<img class="head-img mui-action-preview" id="yyzz-img" src="../img/my/addphoto.png"/>
							</span>
						</a>
					</li>
					<li class="mui-table-view-cell" id="img-2">
						<a id="sfz" class="mui-navigate-right">身份证正面
							<span class="mui-pull-right head">
								<input type="hidden" id="sfz-img-src" value="">
								<img class="head-img mui-action-preview" id="sfz-img" src="../img/my/addphoto.png"/>
							</span>
						</a>
					</li>
					<li class="mui-table-view-cell" id="img-3">
						<a id="sfz1" class="mui-navigate-right">身份证反面
							<span class="mui-pull-right head">
								<input type="hidden" id="sfz-img1-src" value="">
								<img class="head-img mui-action-preview" id="sfz-img1" src="../img/my/addphoto.png"/>
							</span>
						</a>
					</li>
					<li class="mui-table-view-cell" id="img-4">
						<a id="sfz2" class="mui-navigate-right">身份证手持照
							<span class="mui-pull-right head">
								<input type="hidden" id="sfz-img2-src" value="">
								<img class="head-img mui-action-preview" id="sfz-img2" src="../img/my/addphoto.png"/>
							</span>
						</a>
					</li>
					<li class="mui-table-view-cell" id="img-0">
						<a id="mtz" class="mui-navigate-right">门头照
							<span class="mui-pull-right head">
								<input type="hidden" id="mtz-img-src" value="">
								<img class="head-img mui-action-preview" id="mtz-img" src="../img/my/addphoto.png"/>
							</span>
						</a>
					</li>
					<li class="mui-table-view-cell" id="img-5">
						<a id="zxfc" class="mui-navigate-right">专线风采
							<span class="mui-pull-right head">
								<input type="hidden" id="zxfc-img-src" value="">
								<img class="head-img mui-action-preview" id="zxfc-img" src="../img/my/addphoto.png"/>
							</span>
						</a>
					</li>
				</ul>
			<div class="mui-content-padded">
				<button id='chongzhimima' class="mui-btn mui-btn-block mui-btn-primary">提交审核</button>
			</div>
		</div>
		<script src="../js/mui.min.js"></script>
		<script src='../js/feedback.js'></script>
		<script src="../js/zepto.js"></script>
		<script src="../js/reconnecting-websocket.min.js"></script>
		<script src="../js/stomp.min.js"></script>
		<script src="../js/sockjs.min.js"></script>
		<script src="../js/app.js"></script>
		<script src="../js/mui.picker.min.js"></script>
		<script src="../js/mui.poppicker.js"></script>
		<script>
			document.addEventListener("plusready", plusReady, false);  
            function plusReady() {
                document.getElementById("img-1").addEventListener("tap", function() {  
                		//clicked('photo.html',{},'slide-in-right');
                    showActionSheet(1);//拍照还是相册  
                });
                document.getElementById("img-2").addEventListener("tap", function() {  
                		//clicked('photo.html',{},'slide-in-right');
                    showActionSheet(2);//拍照还是相册  
                });
                document.getElementById("img-3").addEventListener("tap", function() {  
                		//clicked('photo.html',{},'slide-in-right');
                    showActionSheet(3);//拍照还是相册  
                });
                document.getElementById("img-4").addEventListener("tap", function() {  
                		//clicked('photo.html',{},'slide-in-right');
                    showActionSheet(4);//拍照还是相册  
                });
                document.getElementById("img-0").addEventListener("tap", function() {  
                		//clicked('photo.html',{},'slide-in-right');
                    showActionSheet(0);//拍照还是相册  
                });
                document.getElementById("img-5").addEventListener("tap", function() {  
                		//clicked('photo.html',{},'slide-in-right');
                    showActionSheet(5);//拍照还是相册  
                });
                plus.nativeUI.closeWaiting();
                var data = {
					queryData:{
						tradeCode:'tbbuser.selectByPrimaryKey',
						userid:localStorage.getItem('userid')
					}
				};
				lnjoy.GetDataByPost(data,function(rs){
					console.log('%o',rs);
					$('#MDDZ').val(rs.list[0].address);
					$('#XLQD').val(rs.list[0].fromroute);
					$('#XLZD').val(rs.list[0].toroute);
					$('#textarea').val(rs.list[0].usercontent);
					$('#usertel').val(rs.list[0].usertel);
				});
            }
            function showActionSheet(imgindex) {  
                var bts = [{  
                    title: "拍照"  
                }, {  
                    title: "从相册选择"  
                }];  
                plus.nativeUI.actionSheet({  
                        cancel: "取消",  
                        buttons: bts  
                    },  
                    function(e) {  
                        if (e.index == 1) {  
                            getImage(imgindex);  
                        } else if (e.index == 2) {  
                            galleryImgs(imgindex);
                        }  
                    }  
                );  
            }
            
            var citydata = {
				queryData:{
					tradeCode:'dq',
					dqBm:'000000'
				}
			};
			lnjoy.GetDataByPost(citydata,function(rs){
				var citys = [];
				for(var i = 0;i < rs[0].child.length;i++)
				{
					var city_arr = [];
					for(var j = 0; j<rs[0].child[i].child.length;j++)
					{
						var citys_2 = {
							value:rs[0].child[i].child[j].dqBm,
							text:rs[0].child[i].child[j].dqMc
						}
						city_arr.push(citys_2);
					}
					var citys_1 = {
						value:rs[0].child[i].dqBm,
						text:rs[0].child[i].dqMc,
						children:city_arr
					}
					citys.push(citys_1);
				}
				var cityPicker = new mui.PopPicker({
					layer: 2
				});
				cityPicker.setData(citys);
				var showCityPickerButton = document.getElementById('XLQD');
				showCityPickerButton.addEventListener('tap', function(event) {
					cityPicker.show(function(items) {
						$('#XLQD').val(items[1].text.replace('市',''));
					});
				}, false); 
			});
            
            document.getElementById('chongzhimima').addEventListener('tap', function() {
            		if(!$('#MDDZ').val())
            		{
            			mui.toast('请输入门店地址');
            			return;
            		}
            		if(!$('#usertel').val())
            		{
            			mui.toast('请输入联系电话');
            			return;
            		}
            		if(!$('#XLQD').val())
            		{
            			mui.toast('请输入线路起点');
            			return;
            		}
            		if(!$('#XLZD').val())
            		{
            			mui.toast('请输入线路终点');
            			return;
            		}
            		if($('#XLZD').val().length>13)
            		{
            			mui.toast('线路终点字数过多，请重新填写');
            			return;
            		}
            		if(!$('#textarea').val())
            		{
            			mui.toast('请输入专线简介');
            			return;
            		}
            		var data = {
            			queryData:{
            				tradeCode:"tbbuser.updateByPrimaryKeySelective104",
            				userid:localStorage.getItem('userid'),
            				address:$('#MDDZ').val(),
            				fromroute:$('#XLQD').val(),
            				toroute:$('#XLZD').val(),
            				usercontent:$('#textarea').val(),
            				usertel:$('#usertel').val(),
            				returnSelect:'null'
            			}
            		}
            		console.log('%o',data);
            		lnjoy.GetDataByPost(data,function(rs){
            			console.log('%o',rs);
            			if(rs.hasOwnProperty("success"))
            			{
            				mui.toast('补充信息成功');
            				mui.back();
            			}else
            			{
            				mui.toast('补充信息失败');
            				return;
            			}
            		});
            });
             
            // 上传文件  
            function upload(files,imgindex) {
            		console.log("开始上传");
            		console.log('%O',files);
                var task = plus.uploader.createUpload('http://'+host+':8010/api/yfq/uploadMultipleFiles', {
                        method: "POST"  
                    },
                    function(t, status) { //上传完成
                    		console.log("结束了");
                    		console.log('%o',status);
                        if (status == 200) {
                        		console.log('%o',t);
                        		var result =JSON.parse(t.responseText);
                        		console.log('%o',result);
                            var data1 = {
                            		queryData:{
									tradeCode:"tbbuserphoto.update104",
									userid:localStorage.getItem('userid'),
									userphotogltype:imgindex,
									fileList:result
								}
                            }
                            lnjoy.GetDataByPost(data1,function(rs1){
                            		console.log('%o',rs1);
                            })
                        } else {  
                            console.log("上传失败：" + status);
                        }  
                    }
                );  
            
                for (var i = 0; i < files.length; i++) {
                    var f = files[i];
                    task.addFile(f.path, {  
                        key:f.name
                    });
                    
                  }
                task.start();
                  
            }  
            
            function compressImage(src,dstname) {  
                //var dstname="_downloads/"+getUid()+".jpg";  
                plus.zip.compressImage({  
                        src: src,  
                        dst: dstname,  
                        overwrite:true,  
                        quality: 20  
                    },  
                    function(event) {  
                        //console.log("Compress success:"+event.target);  
                        return event.target;  
                    },  
                    function(error) {  
                        console.log(error);  
                        return src;  
                        //alert("Compress error!");  
                    });
            }
              
            // 添加文件  
            var index = 1;  
            var newUrlAfterCompress;  
            function appendFile(p) {  
                files.push({ 
                    path: p,
                    name: "uploadkey_" + index
                });  
                index++;  
            }  
            // 产生一个随机数  
            function getUid() {  
                return Math.floor(Math.random() * 100000000 + 10000000).toString();  
            }  
            //拍照  
            function getImage(imgindex) {  
                var cmr = plus.camera.getCamera();  
                cmr.captureImage(function(p) {  
                    plus.io.resolveLocalFileSystemURL(p, function(entry) {  
                        var localurl = entry.toLocalURL(); //  
                        if(imgindex == 1)
	                		{
	                			$('#yyzz-img').attr('src',localurl);
							$('#yyzz-img-src').val(localurl);
							var file_obj = {path: localurl,name:'yyzz'};
							var files = [];
							files.push(file_obj);
							upload(files,imgindex);
	                		}else if(imgindex == 2)
	                		{
	                			$('#sfz-img').attr('src',localurl);
							$('#sfz-img-src').val(localurl);
							var file_obj = {path: localurl,name:'sfz'};
							var files = [];
							files.push(file_obj);
							upload(files,imgindex);
	                		}else if(imgindex == 3)
	                		{
	                			$('#sfz-img1').attr('src',localurl);
							$('#sfz-img1-src').val(localurl);
							var file_obj = {path: localurl,name:'sfz1'};
							var files = [];
							files.push(file_obj);
							upload(files,imgindex);
	                		}else if(imgindex == 4)
	                		{
	                			$('#sfz-img2').attr('src',localurl);
							$('#sfz-img2-src').val(localurl);
							var file_obj = {path: localurl,name:'sfz2'};
							var files = [];
							files.push(file_obj);
							upload(files,imgindex);
	                		}else if(imgindex == 0)
	                		{
	                			$('#mtz-img').attr('src',localurl);
							$('#mtz-img-src').val(localurl);
							var file_obj = {path: localurl,name:'mtz'};
							var files = [];
							files.push(file_obj);
							upload(files,imgindex);
	                		}else if(imgindex == 5)
	                		{
	                			$('#zxfc-img').attr('src',localurl);
							$('#zxfc-img-src').val(localurl);
							var file_obj = {path: localurl,name:'zxfc'};
							var files = [];
							files.push(file_obj);
							upload(files,imgindex);
	                		}
                        //$(".dynamic_images ul li").remove(".pickimg");  
//                      $(".dynamic_images ul").prepend("<li class='pickimg'><img src='" + localurl + "' /></li>");
//                       var dstname="_downloads/"+getUid()+".jpg";//设置压缩后图片的路径  
//                          newUrlAfterCompress=compressImage(localurl,dstname);  
//                          appendFile(dstname); 
                    });  
                });  
            }  
            function galleryImgs(imgindex) { // 从相册中选择图片  
                plus.gallery.pick(function(e) {  
                		if(imgindex == 1)
                		{
                			if(e.files.length>1)
						{
							mui.toast('营业执照最多上传一张');
							return;
						}else
						{
							$('#yyzz-img').attr('src',e.files[0]);
							$('#yyzz-img-src').val(e.files[0]);
							var file_obj = {path: e.files[0],name:'yyzz'};
							var files = [];
							files.push(file_obj);
							upload(files,imgindex);
						}
                		}else if(imgindex == 2)
                		{
                			if(e.files.length>1)
						{
							mui.toast('身份证正面照最多上传一张');
							return;
						}else
						{
							$('#sfz-img').attr('src',e.files[0]);
							$('#sfz-img-src').val(e.files[0]);
							var file_obj = {path: e.files[0],name:'sfz'};
							var files = [];
							files.push(file_obj);
							upload(files,imgindex);
						}
                		}else if(imgindex == 3)
                		{
                			if(e.files.length>1)
						{
							mui.toast('身份证反面照最多上传一张');
							return;
						}else
						{
							$('#sfz-img1').attr('src',e.files[0]);
							$('#sfz-img1-src').val(e.files[0]);
							var file_obj = {path: e.files[0],name:'sfz1'};
							var files = [];
							files.push(file_obj);
							upload(files,imgindex);
						}
                		}else if(imgindex == 4)
                		{
                			if(e.files.length>1)
						{
							mui.toast('身份证手持照最多上传一张');
							return;
						}else
						{
							$('#sfz-img2').attr('src',e.files[0]);
							$('#sfz-img2-src').val(e.files[0]);
							var file_obj = {path: e.files[0],name:'sfz2'};
							var files = [];
							files.push(file_obj);
							upload(files,imgindex);
						}
                		}else if(imgindex == 0)
                		{
                			if(e.files.length>1)
						{
							mui.toast('门头照最多上传一张');
							return;
						}else
						{
							$('#mtz-img').attr('src',e.files[0]);
							$('#mtz-img-src').val(e.files[0]);
							var file_obj = {path: e.files[0],name:'mtz'};
							var files = [];
							files.push(file_obj);
							upload(files,imgindex);
						}
                		}else if(imgindex == 5)
                		{
                			if(e.files.length>1)
						{
							mui.toast('专线风采最多上传一张');
							return;
						}else
						{
							$('#zxfc-img').attr('src',e.files[0]);
							$('#zxfc-img-src').val(e.files[0]);
							var file_obj = {path: e.files[0],name:'zxfc'};
							var files = [];
							files.push(file_obj);
							upload(files,imgindex);
						}
                		}
                    //$(".dynamic_images ul li").remove(".pickimg");  
                    //console.log("选择了"+e.files.length+"个图片");  
//                  for (var i = 0; i < e.files.length; i++) {  
//                      if (i < 9) {  
//                          $(".dynamic_images ul").prepend("<li class='pickimg'><img src='" + e.files[i] + "' /></li>");  
//                          var dstname="_downloads/"+getUid()+".jpg";//设置压缩后图片的路径  
//                          newUrlAfterCompress=compressImage(e.files[i],dstname);
//                          appendFile(dstname);
//                      }  
//                  }  
                }, function(e) {  
                    console.log("取消选择图片");  
                }, {  
                    filter: "image",  
                    multiple: true  
                });  
            }  
		</script>
	</body>
</html>